import { init } from '../src/init.js';

vi.mock('@inquirer/prompts', () => ({
  select: vi.fn(),
  input: vi.fn(),
}));

vi.mock('@mintlify/previewing', () => ({
  addLogs: vi.fn(),
  addLog: vi.fn(),
  SpinnerLog: vi.fn(),
  removeLastLog: vi.fn(),
}));

vi.mock('@mintlify/validation', async () => {
  const original =
    await vi.importActual<typeof import('@mintlify/validation')>('@mintlify/validation');
  return {
    ...original,
    docsConfigSchema: {
      options: [{ shape: { theme: { _def: { value: 'quill' } } } }],
    },
  };
});

vi.mock('fs-extra', () => ({
  default: {
    readdir: vi.fn().mockResolvedValue([]),
    ensureDir: vi.fn().mockResolvedValue(undefined),
    writeFile: vi.fn().mockResolvedValue(undefined),
    copy: vi.fn().mockResolvedValue(undefined),
    remove: vi.fn().mockResolvedValue(undefined),
    readJson: vi.fn().mockResolvedValue({ theme: 'quill', name: 'Test' }),
    writeJson: vi.fn().mockResolvedValue(undefined),
  },
}));

vi.mock('adm-zip', () => ({
  default: vi.fn().mockImplementation(() => ({
    extractAllTo: vi.fn(),
  })),
}));

global.fetch = vi.fn().mockResolvedValue({
  arrayBuffer: () => Promise.resolve(new ArrayBuffer(0)),
});

describe('init', () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  describe('path traversal prevention', () => {
    it('rejects path traversal with ../', async () => {
      await expect(init('../outside', false, 'quill', 'Test')).rejects.toThrow(
        'Access denied: path: ../outside is outside the current directory'
      );
    });

    it('rejects deep path traversal', async () => {
      await expect(init('../../../etc', false, 'quill', 'Test')).rejects.toThrow(
        'Access denied: path: ../../../etc is outside the current directory'
      );
    });

    it('rejects absolute paths outside cwd', async () => {
      await expect(init('/etc/test', false, 'quill', 'Test')).rejects.toThrow(
        'Access denied: path: /etc/test is outside the current directory'
      );
    });

    it('allows current directory (.)', async () => {
      // Should not throw for current directory
      await expect(init('.', false, 'quill', 'Test')).resolves.not.toThrow();
    });

    it('allows subdirectory paths', async () => {
      // Should not throw for subdirectory
      await expect(init('docs', false, 'quill', 'Test')).resolves.not.toThrow();
    });

    it('allows nested subdirectory paths', async () => {
      // Should not throw for nested subdirectory
      await expect(init('docs/api', false, 'quill', 'Test')).resolves.not.toThrow();
    });
  });
});
