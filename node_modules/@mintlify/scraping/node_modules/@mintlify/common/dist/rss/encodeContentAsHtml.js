import { fromHtml } from 'hast-util-from-html';
import rehypeStringify from 'rehype-stringify';
import remarkGfm from 'remark-gfm';
import remarkParse from 'remark-parse';
import remarkRehype from 'remark-rehype';
import { unified } from 'unified';
import { visit } from 'unist-util-visit';
const DANGEROUS_TAGS = ['script', 'iframe', 'object', 'embed', 'style'];
const rehypeRaw = () => {
    return (tree) => {
        visit(tree, 'raw', (raw, index, parent) => {
            if ('value' in raw && parent && index !== undefined) {
                const rawAst = fromHtml(raw.value, { fragment: true });
                parent.children.splice(index, 1, ...rawAst.children);
            }
        });
    };
};
const rehypeSanitizeDangerous = () => {
    return (tree) => {
        visit(tree, 'element', (node, index, parent) => {
            if (parent && typeof index === 'number' && DANGEROUS_TAGS.includes(node.tagName)) {
                parent.children.splice(index, 1);
                return ['skip', index];
            }
        });
    };
};
export const encodeContentAsHtml = (content) => {
    const html = unified()
        .use(remarkParse)
        .use(remarkGfm)
        .use(remarkRehype, { allowDangerousHtml: true })
        .use(rehypeRaw)
        .use(rehypeSanitizeDangerous)
        .use(rehypeStringify, { allowDangerousHtml: true })
        .processSync(content)
        .toString();
    return html;
};
